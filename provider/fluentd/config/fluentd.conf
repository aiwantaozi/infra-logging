<source>
    @type  tail
    path  /var/log/containers/*.log
    pos_file  /fluentd/log/fluentd-kubernetes.pos
    time_format  %Y-%m-%dT%H:%M:%S
    tag  kubernetes.*
    format  json
    read_from_head  true
</source>
<source>
    @type  monitor_agent
    bind  0.0.0.0
    port  24220
</source>
<filter  kubernetes.**>
    type  kubernetes_metadata
    merge_json_log  true
    preserve_json_log  true
</filter>
<filter  kubernetes.**>
    @type  record_transformer
    enable_ruby  true
    <record>
        kubernetes_namespace_container_name $${record["kubernetes"]["namespace_name"]}.$${record["kubernetes"]["container_name"]}     
    </record>
</filter>
#  retag  based  on  the  container  name  of  the  log  message
<match  kubernetes.**>
    @type  rewrite_tag_filter
    rewriterule1  kubernetes_namespace_container_name    ^(.+)$$  kubernetes.$$1
</match>
    #  Remove  the  unnecessary  field  as  the  information  is  already  available  on
    #  other  fields.
<filter  kubernetes.**>
    @type  record_transformer
    remove_keys  kubernetes_namespace_container_name
</filter>
<match  kubernetes.testing.**>
    @type  copy
    <store>
        @type  elasticsearch
        host  es-client-lb.es-cluster.rancher.internal
        port  9200
        logstash_format  true
        logstash_prefix  rancher-k8s-testing
        logstash_dateformat  %Y%m%d             include_tag_key  true
        type_name  access_log
        tag_key  @log_name
        flush_interval  1s
    </store>
</match>
<match  kubernetes.**>         
    @type  copy          
    <store>
        @type  elasticsearch
        host  es-client-lb.es-cluster.rancher.internal            
        port  9200
        logstash_format  true
        logstash_prefix  fluentd-kubernetes-k8s
        logstash_dateformat  %Y%m%d
        include_tag_key  true
        type_name  access_log
        tag_key  @log_name
        flush_interval  1s
    </store> 
</match>



