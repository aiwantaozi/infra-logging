<source>
    @type  tail
    path  /var/log/containers/*.log
    pos_file  /fluentd/log/fluentd-kubernetes.pos
    time_format  %Y-%m-%dT%H:%M:%S
    tag  kubernetes.*
    format  json
    read_from_head  true
</source>
<source>
    @type  monitor_agent
    bind  0.0.0.0
    port  24220
</source>

<source>
  @type tail
  path /Users/fengcaixiao/Desktop/work/src/github.com/aiwantaozi/infra-logging/logs/my.log
  pos_file /Users/fengcaixiao/Desktop/work/src/github.com/aiwantaozi/infra-logging/logs/my.log.pos
  tag services.*
  format apache2
</source>
<filter  kubernetes.**>
    type  kubernetes_metadata
    merge_json_log  true
    preserve_json_log  true
</filter>
<filter  kubernetes.**>
    @type  record_transformer
    enable_ruby  true
    <record>
        kubernetes_namespace_container_name $${record["kubernetes"]["namespace_name"]}.$${record["kubernetes"]["container_name"]}     
    </record>
</filter>
#  retag  based  on  the  container  name  of  the  log  message
<match  kubernetes.**>
    @type  rewrite_tag_filter
    rewriterule1  kubernetes_namespace_container_name    ^(.+)$$  kubernetes.$$1
</match>
    #  Remove  the  unnecessary  field  as  the  information  is  already  available  on
    #  other  fields.
<filter  kubernetes.**>
    @type  record_transformer
    remove_keys  kubernetes_namespace_container_name
</filter>
<match  **.**>         
    @type  copy        
    <store>
        @type  aws-elasticsearch-service
        host  aws           
        port  9090
        logstash_format  true
        logstash_prefix  helloworld
        logstash_dateformat  %Y-%m-%d %H:%M:%S
        include_tag_key  true
        type_name  access_log
        tag_key hellotagkey
        flush_interval  1s
        <endpoint>
        access_key_id test_access_key
            region eu-west-1
            secret_access_key test_access_secret
            url test2
            </endpoint>
        </store>
    <store>
        @type  aws-elasticsearch-service
        host  aws           
        port  9090
        logstash_format  true
        logstash_prefix  helloworld
        logstash_dateformat  %Y-%m-%d %H:%M:%S
        include_tag_key  true
        type_name  access_log
        tag_key hellotagkey
        flush_interval  1s
        </store>
    </match>